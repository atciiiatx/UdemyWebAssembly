<html>

<head>
    <meta charset="utf-8">
    <title>WebAssembly Demo</title>
</head>

<body>
    <h1>WebAssembly Demo</h1>
    <script>
        // Read a string from WebAssembly memory
        const readMemStr = (s, length) => {
            const strBuffer = new Uint8Array(wasm.instance.exports.memory.buffer, s, length)
            const str = new TextDecoder().decode(strBuffer)
            
            // Notify of new string
            window.dispatchEvent(new CustomEvent('wasmValue', {detail: str}))
        }

        // Listen for new string
        window.addEventListener('wasmValue', str => {
            console.log('Received string: ', str.detail)
        })
        // Imports object
        const imports = {
            env: {
                numLog: console.log,
                strLog: readMemStr
            }
        }
        // Load WASM
        WebAssembly.instantiateStreaming(fetch('/program.wasm'), imports).then
            (wasm => {
                console.log('WASM Ready.');
                // Make it accessible
                window.wasm = wasm

                // Test
                console.log(wasm.instance.exports.getDoubleNumber(80))
                wasm.instance.exports.testNumLog(77)
                wasm.instance.exports.testStrLog()
            })
    </script>
</body>

</html>